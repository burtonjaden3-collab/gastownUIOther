# Ralph Progress — Fix Circuit Breaker False Trips

Project: GasTownUI
Branch: ralph/fix-circuit-breaker-false-trips
Stories: 6
Completed: 5

## Codebase Patterns
- CircuitBreaker is in `src/lib/server/cli/circuit-breaker.ts`, ProcessSupervisor in `process-supervisor.ts` — both in the same `cli/` directory
- ProcessSupervisor.getStats() uses `ReturnType<CircuitBreaker['getStats']>` for its type — changes to CircuitBreaker.getStats() automatically propagate
- ProcessSupervisor uses per-domain circuit breakers via `Map<string, CircuitBreaker>` — domain key is `${command}-${args[0] || 'default'}` (e.g. 'gt-mail', 'bd-list')
- `executeCommand()` receives the breaker as a parameter (captured in closure from `execute()`) — don't re-derive domain inside executeCommand
- No route files directly reference CircuitBreaker or getStats()/resetCircuitBreaker() — changes to these are internal to ProcessSupervisor
- Pre-existing `tsc --noEmit` errors (4 Svelte type export issues) are not regressions; use `npx svelte-check` as the authoritative typecheck for this project
- CircuitBreaker.reset() clears all counters — remember to include new fields there when adding state
- `COMMAND_ERROR_PATTERNS` is a module-level constant in process-supervisor.ts — add new patterns there when discovering new command-level error strings
- Error classification in `executeCommand()`: check `!wasKilled` first, then pattern-match stderr — infrastructure errors (killed/timeout/ENOENT) always go to `recordFailure()`
- `gt mq list` requires a rig name argument — use `gt mq list <rigName> --json` for each rig, never bare `gt mq --json`
- SSE polling loop has `rigNames` available from Step 1 — reuse it for per-rig commands in later steps
- `gt mol status --json` returns current hook molecule (may be single object, not array) — always normalize to array
- `gt mol progress <id> --json` replaces `gt mol show <id> --json` for molecule detail
- Handle 'no beads database found' in molecule endpoints by returning empty data with 200, not 500/503

## 2026-01-26 - US-001
- What was implemented: Added `recordCommandError()` method to CircuitBreaker that increments a `commandErrorCount` counter without affecting `failureCount` or circuit state. Updated `getStats()` to include the new `commandErrorCount` field. Updated `reset()` to clear the new counter.
- Files changed: `src/lib/server/cli/circuit-breaker.ts`
- **Learnings for future iterations:**
  - ProcessSupervisor uses `ReturnType<CircuitBreaker['getStats']>` so adding fields to CircuitBreaker.getStats() automatically flows through
  - `tsc --noEmit` has 4 pre-existing errors related to Svelte module type exports (BreadcrumbItem, Selection, WorkTab) — these are NOT regressions
  - Use `npx svelte-check` for accurate type validation in this Svelte 5 project
---

## 2026-01-26 - US-002
- What was implemented: Refactored ProcessSupervisor to use per-domain circuit breakers instead of a single shared breaker. Added `getDomainKey()` (returns `${command}-${args[0] || 'default'}`) and `getBreaker()` (lazy-creates breakers per domain). Updated `execute()` to derive domain and check domain-specific breaker. Updated `executeCommand()` to accept a breaker parameter. Changed `getStats()` to return `Record<string, CircuitBreakerStats>`. Changed `resetCircuitBreaker()` to accept optional domain string.
- Files changed: `src/lib/server/cli/process-supervisor.ts`
- **Learnings for future iterations:**
  - The breaker is passed into `executeCommand()` via closure capture from `execute()` — avoids re-deriving the domain key inside the callback
  - `getStats().circuitBreaker` is now a `Record<string, ...>` instead of a flat object — any code consuming this will need to iterate domains
  - No route handlers directly consume `getStats()` or `resetCircuitBreaker()` — the type change is internal
  - Breakers are lazily created on first use for each domain — no need to pre-populate
---

## 2026-01-26 - US-003
- What was implemented: Added error classification logic to `executeCommand()` in ProcessSupervisor. Before calling `recordFailure()`, the error handler now checks if stderr matches known command-error patterns (`unknown flag`, `unknown command`, `no beads database found`, `error: unknown`, `not a valid command`) AND the process was not killed/timed out. If so, calls `recordCommandError()` instead of `recordFailure()`. Added `COMMAND_ERROR_PATTERNS` module-level constant. Infrastructure errors (spawn failure, timeout, kill) still call `recordFailure()`.
- Files changed: `src/lib/server/cli/process-supervisor.ts`
- **Learnings for future iterations:**
  - The `isTimeout`/`wasKilled` variables needed to be moved BEFORE the breaker recording logic since classification depends on them
  - Patterns are compared case-insensitively (lowercase both stderr and patterns) to handle varied CLI output formatting
  - The spawn `'error'` event handler (ENOENT etc.) is separate from the execFile callback — it correctly remains as `recordFailure()` since spawn failures are always infrastructure errors
  - `svelte-check` passed with 0 errors and 0 warnings — clean typecheck
---

## 2026-01-26 - US-004
- What was implemented: Fixed `gt mq` command usage in both SSE polling and mergequeue endpoint. In SSE events Step 6, replaced the single `supervisor.gt(['mq', '--json'])` call with a per-rig loop calling `supervisor.gt(['mq', 'list', rigName, '--json'])` for each rig, aggregating results into a single items array. Added guard to skip merge queue polling when `rigNames` is empty. In mergequeue endpoint, added `?rig=` query parameter support — if provided, queries only that rig; otherwise falls back to `getRigNames()` and aggregates across all rigs.
- Files changed: `src/routes/api/gastown/events/+server.ts`, `src/routes/api/gastown/mergequeue/+server.ts`
- **Learnings for future iterations:**
  - `gt mq list` requires a rig name argument — `gt mq --json` alone is invalid syntax and triggers command errors
  - The SSE polling loop already has `rigNames` available from Step 1 — reuse it rather than calling `getRigNames()` again
  - The mergequeue endpoint already had correct per-rig `gt mq list` calls from a previous fix — only needed the `?rig=` query param addition
  - SvelteKit route handlers can destructure `{ url }` from the request event to access query params via `url.searchParams`
  - `svelte-check` passed with 0 errors and 0 warnings
---

## 2026-01-26 - US-005
- What was implemented: Fixed molecule endpoint commands. In molecules list endpoint, replaced `['mol', 'list', '--active', '--json']` with `['mol', 'status', '--json']`. Added handling for single-object response by wrapping in array (`data ? [data] : []`). In molecule detail endpoint, replaced `['mol', 'show', id, '--json']` with `['mol', 'progress', id, '--json']`. Both endpoints now handle 'no beads database found' errors gracefully — returning empty data with 200 status instead of 500/503.
- Files changed: `src/routes/api/gastown/molecules/+server.ts`, `src/routes/api/gastown/molecules/[id]/+server.ts`
- **Learnings for future iterations:**
  - `gt mol status --json` may return a single object (not array) when one molecule is attached to the hook — always normalize with `Array.isArray(data) ? data : data ? [data] : []`
  - `gt mol progress <id> --json` is the correct subcommand for molecule detail, not `gt mol show`
  - The 'no beads database found' pattern check should be case-insensitive (`.toLowerCase()`) since CLI output formatting varies
  - Both molecule endpoints follow the same pattern: check `result.error` for beads DB absence before returning 503
  - `svelte-check` passed with 0 errors and 0 warnings
---
