# Ralph Progress — Fix Circuit Breaker False Trips

Project: GasTownUI
Branch: ralph/fix-circuit-breaker-false-trips
Stories: 6
Completed: 3

## Codebase Patterns
- CircuitBreaker is in `src/lib/server/cli/circuit-breaker.ts`, ProcessSupervisor in `process-supervisor.ts` — both in the same `cli/` directory
- ProcessSupervisor.getStats() uses `ReturnType<CircuitBreaker['getStats']>` for its type — changes to CircuitBreaker.getStats() automatically propagate
- ProcessSupervisor uses per-domain circuit breakers via `Map<string, CircuitBreaker>` — domain key is `${command}-${args[0] || 'default'}` (e.g. 'gt-mail', 'bd-list')
- `executeCommand()` receives the breaker as a parameter (captured in closure from `execute()`) — don't re-derive domain inside executeCommand
- No route files directly reference CircuitBreaker or getStats()/resetCircuitBreaker() — changes to these are internal to ProcessSupervisor
- Pre-existing `tsc --noEmit` errors (4 Svelte type export issues) are not regressions; use `npx svelte-check` as the authoritative typecheck for this project
- CircuitBreaker.reset() clears all counters — remember to include new fields there when adding state
- `COMMAND_ERROR_PATTERNS` is a module-level constant in process-supervisor.ts — add new patterns there when discovering new command-level error strings
- Error classification in `executeCommand()`: check `!wasKilled` first, then pattern-match stderr — infrastructure errors (killed/timeout/ENOENT) always go to `recordFailure()`

## 2026-01-26 - US-001
- What was implemented: Added `recordCommandError()` method to CircuitBreaker that increments a `commandErrorCount` counter without affecting `failureCount` or circuit state. Updated `getStats()` to include the new `commandErrorCount` field. Updated `reset()` to clear the new counter.
- Files changed: `src/lib/server/cli/circuit-breaker.ts`
- **Learnings for future iterations:**
  - ProcessSupervisor uses `ReturnType<CircuitBreaker['getStats']>` so adding fields to CircuitBreaker.getStats() automatically flows through
  - `tsc --noEmit` has 4 pre-existing errors related to Svelte module type exports (BreadcrumbItem, Selection, WorkTab) — these are NOT regressions
  - Use `npx svelte-check` for accurate type validation in this Svelte 5 project
---

## 2026-01-26 - US-002
- What was implemented: Refactored ProcessSupervisor to use per-domain circuit breakers instead of a single shared breaker. Added `getDomainKey()` (returns `${command}-${args[0] || 'default'}`) and `getBreaker()` (lazy-creates breakers per domain). Updated `execute()` to derive domain and check domain-specific breaker. Updated `executeCommand()` to accept a breaker parameter. Changed `getStats()` to return `Record<string, CircuitBreakerStats>`. Changed `resetCircuitBreaker()` to accept optional domain string.
- Files changed: `src/lib/server/cli/process-supervisor.ts`
- **Learnings for future iterations:**
  - The breaker is passed into `executeCommand()` via closure capture from `execute()` — avoids re-deriving the domain key inside the callback
  - `getStats().circuitBreaker` is now a `Record<string, ...>` instead of a flat object — any code consuming this will need to iterate domains
  - No route handlers directly consume `getStats()` or `resetCircuitBreaker()` — the type change is internal
  - Breakers are lazily created on first use for each domain — no need to pre-populate
---

## 2026-01-26 - US-003
- What was implemented: Added error classification logic to `executeCommand()` in ProcessSupervisor. Before calling `recordFailure()`, the error handler now checks if stderr matches known command-error patterns (`unknown flag`, `unknown command`, `no beads database found`, `error: unknown`, `not a valid command`) AND the process was not killed/timed out. If so, calls `recordCommandError()` instead of `recordFailure()`. Added `COMMAND_ERROR_PATTERNS` module-level constant. Infrastructure errors (spawn failure, timeout, kill) still call `recordFailure()`.
- Files changed: `src/lib/server/cli/process-supervisor.ts`
- **Learnings for future iterations:**
  - The `isTimeout`/`wasKilled` variables needed to be moved BEFORE the breaker recording logic since classification depends on them
  - Patterns are compared case-insensitively (lowercase both stderr and patterns) to handle varied CLI output formatting
  - The spawn `'error'` event handler (ENOENT etc.) is separate from the execFile callback — it correctly remains as `recordFailure()` since spawn failures are always infrastructure errors
  - `svelte-check` passed with 0 errors and 0 warnings — clean typecheck
---
